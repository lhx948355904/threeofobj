<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<script type="text/javascript" src="js/jquery-2.0.3.min.js"></script>
		<script type="text/javascript" src="js/three.js"></script>
		<script type="text/javascript" src="js/TrackballControls.js"></script>
		<script type="text/javascript" src="js/DDSLoader.js"></script>
		<script type="text/javascript" src="js/OBJLoader.js"></script>
		<script type="text/javascript" src="js/OBJMTLLoader.js"></script>
		<script src="https://ithanmang.gitee.io/threejs/home/libs/examples/js/Detector.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://ithanmang.gitee.io/threejs/home/libs/examples/js/libs/dat.gui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="http://www.yanhuangxueyuan.com/threejs/examples/js/controls/OrbitControls.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://ithanmang.gitee.io/threejs/home/libs/examples/js/controls/TransformControls.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://ithanmang.gitee.io/threejs/home/libs/examples/js/controls/DragControls.js" type="text/javascript" charset="utf-8"></script>
		
		<title></title>
	</head>
	<style>
		body {
			margin: 0;
			overflow: hidden;
			position: relative;
		}
		
		#label {
			position: absolute;
			padding: 10px;
			background: rgba(255, 255, 255, 0.6);
			line-height: 1;
			border-radius: 5px;
		}
		
		.table {
			position: absolute;
			left: 20px;
			top: 20px;
			z-index: 99999;
		}
		
		table th,
		table td {
			border: 1px solid black;
			padding: 8px 10px;
			font-size: 12px;
		}
	</style>

	<body>
		<!--<div id="percent"></div>-->
		<div id="label"></div>
		<div class="table">
			<div>
				爆炸效果
				<input type="range" name="range" id="range" value="" />
			</div>
			<div>
				<span class="reset">重置</span>
			</div>
			<table cellspacing="0">
				<tr>
					<th>精益表格</th>
					<th>精益表格</th>
					<th>精益表格</th>
					<th>精益表格</th>
					<th>精益表格</th>
				</tr>
				<tr>
					<td>精益数据</td>
					<td>精益数据</td>
					<td>精益数据</td>
					<td>精益数据</td>
					<td><span onclick="bindObj(this)">绑定</span></td>
				</tr>
				<tr>
					<td>精益数据</td>
					<td>精益数据</td>
					<td>精益数据</td>
					<td>精益数据</td>
					<td><span onclick="bindObj(this)">绑定</span></td>
				</tr>
				<tr>
					<td>精益数据</td>
					<td>精益数据</td>
					<td>精益数据</td>
					<td>精益数据</td>
					<td><span onclick="bindObj(this)">绑定</span></td>
				</tr>
			</table>
		</div>

		<script>
			var scene, camera, renderer, controls, light, selectObject, meshArrs, labelToggle = true,
				colorsOfObj = {},
				activeObj;
			var modelBox3 = new THREE.Box3();
			var meshBox3 = new THREE.Box3();

			// 场景
			function initScene() {
				scene = new THREE.Scene();
			}

			// 相机
			function initCamera() {
				camera = new THREE.PerspectiveCamera(10, window.innerWidth / window.innerHeight, 0.1, 2000);
				camera.position.set(50, 30, 30);
			}

			// 渲染器
			function initRenderer() {
				if(Detector.webgl) {
					renderer = new THREE.WebGLRenderer({
						antialias: true
					});
				} else {
					renderer = new THREE.CanvasRenderer();
				}
				renderer.setSize(window.innerWidth, window.innerHeight);
				renderer.setClearColor('#F3F781');
				document.body.appendChild(renderer.domElement);
			}

			// 初始化模型
			function initContent() {
				var raycaster = new THREE.Raycaster()
				var mtlLoader = new THREE.MTLLoader();
				mtlLoader.setPath('obj/');
				mtlLoader.load('08ZDT_HT.mtl', function(materials) {

					materials.preload();

					var objLoader = new THREE.OBJLoader();
					objLoader.setMaterials(materials);
					objLoader.setPath('obj/');
					objLoader.load('08ZDT_HT.obj', function(object) {
						object.scale.set(0.05, 0.05, 0.05);
						meshArrs = object.children;

						for(let x of meshArrs) {
							colorsOfObj[x.uuid] = x.material.color;
						}
						scene.add(object);

					});

				});
			}

			//爆炸效果
			function modelExplode(model, num) {
				modelBox3 = new THREE.Box3();
				modelBox3.expandByObject(model);

				var modelWorldPs = new THREE.Vector3().addVectors(modelBox3.max, modelBox3.min).multiplyScalar(0.5);
				var childBox = new THREE.Box3();
				model.traverse(function(child) {
					if(child.isMesh) {
						childBox.setFromObject(child);
						var childCenter = new THREE.Vector3().addVectors(childBox.max, childBox.min).multiplyScalar(0.5);

						if(isNaN(childCenter.x)) return;
						child.childCenter = new THREE.Vector3().subVectors(childCenter, modelWorldPs).normalize();
						//保存初始坐标
						//child.userData.oldPs = child.getWorldPosition(new THREE.Vector3());
						// console.log("初始坐标",child.userData.oldPs);
						if(!child.isMesh || !child.childCenter) return;
						//爆炸公式
						child.position.copy(childCenter).multiplyScalar(num);
					}
				});

			}

			// 鼠标双击触发的方法
			function onMouseClick(event) {

				function getIntersects(event) {
					event.preventDefault();
					console.log("event.clientX:" + event.clientX)
					console.log("event.clientY:" + event.clientY)

					// 声明 raycaster 和 mouse 变量
					var raycaster = new THREE.Raycaster();
					var mouse = new THREE.Vector2();

					// 通过鼠标点击位置,计算出 raycaster 所需点的位置,以屏幕为中心点,范围 -1 到 1
					mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
					mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

					//通过鼠标点击的位置(二维坐标)和当前相机的矩阵计算出射线位置
					raycaster.setFromCamera(mouse, camera);

					// 获取与射线相交的对象数组，其中的元素按照距离排序，越近的越靠前
					var intersects = raycaster.intersectObjects(meshArrs);

					//返回选中的对象
					return intersects;
				}

				// 获取 raycaster 和所有模型相交的数组，其中的元素按照距离排序，越近的越靠前
				var intersects = getIntersects(event);

				// 获取选中最近的 Mesh 对象
				if(intersects.length != 0 && intersects[0].object instanceof THREE.Mesh) {
					selectObject = intersects[0].object;
					labelToggle = false;
					activeObj = selectObject;

					changeMaterial(selectObject);
					//					modelExplode(selectObject, 20)
				} else {
					labelToggle = false;
				}
			}

			// 获取与射线相交的对象数组
			function getIntersects(event) {
				event.preventDefault();
				console.log("event.clientX:" + event.clientX)
				console.log("event.clientY:" + event.clientY)

				// 声明 raycaster 和 mouse 变量
				var raycaster = new THREE.Raycaster();
				var mouse = new THREE.Vector2();

				// 通过鼠标点击位置,计算出 raycaster 所需点的位置,以屏幕为中心点,范围 -1 到 1
				mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
				mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

				//通过鼠标点击的位置(二维坐标)和当前相机的矩阵计算出射线位置
				raycaster.setFromCamera(mouse, camera);

				// 获取与射线相交的对象数组，其中的元素按照距离排序，越近的越靠前
				var intersects = raycaster.intersectObjects(scene.children);

				//返回选中的对象
				return intersects;
			}

			// 窗口变动触发的方法
			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize(window.innerWidth, window.innerHeight);
			}

			// 键盘按下触发的方法
			function onKeyDown(event) {
				switch(event.keyCode) {
					case 13:
						initCamera();
						initControls();
						break;
				}
			}

			// 改变对象材质属性
			function changeMaterial(object) {
				var material = new THREE.MeshLambertMaterial({
					//					transparent: object.material.transparent ? false : true,
					opacity: 0.9,
					emissiveIntensity: object.material.emissiveIntensity == 10 ? 1 : 1,
					reflectivity: 1,
				});

				var color = new THREE.Color("rgb(65,105,225)");
				if(!color.equals(object.material.color)) {
					object.material.color = color
				} else {
					object.material.color = colorsOfObj[object.uuid]
				}
				object.material.reflectivity = 1;
			}

			// 初始化轨迹球控件
			function initControls() {
				controls = new THREE.TrackballControls(camera, renderer.domElement);
				//controls.noRotate = true;
//				controls.noPan = true;
			}

			// 添加拖拽控件
			function initDragControls() {
				// 添加平移控件
				var transformControls = new THREE.TransformControls(camera, renderer.domElement);
				scene.add(transformControls);

				// 过滤不是 Mesh 的物体,例如辅助网格对象
				var objects = [];
				for(let i = 0; i < scene.children.length; i++) {
					if(scene.children[i].isMesh) {
						objects.push(scene.children[i]);
					}
				}
				console.log(objects)
				// 初始化拖拽控件
				var dragControls = new THREE.DragControls(objects, camera, renderer.domElement);

				// 鼠标略过事件
				dragControls.addEventListener('hoveron', function(event) {
					// 让变换控件对象和选中的对象绑定
					transformControls.attach(event.object);
				});
				// 开始拖拽
				dragControls.addEventListener('dragstart', function(event) {
					controls.enabled = false;
				});
				// 拖拽结束
				dragControls.addEventListener('dragend', function(event) {
					controls.enabled = true;
				});
			}

			// 初始化灯光
			function initLight() {
				light = new THREE.SpotLight('white');
				light.position.set(-300, 300, 300);
				light.castShadow = true;

				scene.add(light);
				scene.add(new THREE.AmbientLight('white'));
			}

			// 初始化 dat.GUI
			function initGui() {
				// 保存需要修改相关数据的对象
				gui = new function() {

				}
				// 属性添加到控件
				var guiControls = new dat.GUI();
			}

			function initOrbitControls() {
				var controls = new THREE.OrbitControls(camera, renderer.domElement); //创建控件对象
				controls.addEventListener('change', animate); //监听鼠标、键盘事件
			}

			function initAxisHelper() {
				var axisHelper = new THREE.AxisHelper(250);
				scene.add(axisHelper);
			}

			// 更新div的位置
			function renderDiv(object) {

				// 获取窗口的一半高度和宽度
				var halfWidth = window.innerWidth / 2;
				var halfHeight = window.innerHeight / 2;

				// 逆转相机求出二维坐标
				var vector = object.position.clone().project(camera);
				// 修改 div 的位置
				$("#label").css({
					left: vector.x * halfWidth + halfWidth,
					top: -vector.y * halfHeight + halfHeight - object.position.y
				});
				// 显示模型信息
				$("#label").html(`
					<div>name:${object.name}</div>
					<div>id:${object.uuid}</div>
				`);

			}

			// 更新控件
			function update() {
				controls.update();
				controls.handleResize();

			}

			// 初始化
			function init() {
				initScene();
				initCamera();
				initRenderer();
				initContent();
				initLight();
				initControls();
				initAxisHelper();
				initDragControls();
				//				initOrbitControls();
				//initGui();

				addEventListener('click', onMouseClick, false);
				addEventListener('resize', onWindowResize, false);
				addEventListener('keydown', onKeyDown, false);

			}

			function animate() {
				if(selectObject != undefined && selectObject != null) {
					renderDiv(selectObject);
				}
				requestAnimationFrame(animate);
				renderer.render(scene, camera);
				update();
			}

			init();
			animate();

			$(".reset").click(() => {
				initCamera();
				initControls();
			})
			
			$("#range").on('input', (e) => {
				for(let x of meshArrs) {
					modelExplode(x, e.target.value * 0.32)
				}
			})

			function bindObj(e) {
				if(activeObj) {
					console.log(activeObj)
					alert('与名称为' + activeObj.name + "的设备绑定成功，调用接口中")
				} else {
					alert('请选择部位')
				}

			}
		</script>

	</body>

</html>